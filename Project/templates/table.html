{% load static %}
{%block content%}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Table</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/table.css' %}">
</head>
<body>
    <div class="container">
        {% comment %} <button class="exit-game-btn" id="exit-game-btn">Exit Game</button>
        {% endcomment %}
        
        <div class="poker-table">
            <!-- Top Icons -->
            <div class="top-icons">
                <button class="icon-button">ℹ</button>
                <button class="icon-button">⚙</button>
            </div>
            
            <!-- Poker Table -->
            <div class="table">
                <p>User ID: {{ user.id }}</p>

                <!-- Players -->
                <div class="players-grid">
                    {% for player in players %}
                    <div class="player" id="player-{{ player.id }}">
                        <img src="{{ player.avatar }}" alt="Image" class="player-img">
                        <div class="player-info">

                            <div class="player-name">{{ player.username }}</div>
                            <div class="player-coins"> {{ player.coins }}</div> 
                            <div class="player-current-bet" id="player-current-bet-{{ player.id }}">♦ {{ player.current_bet }}</div> <!-- Add this line -->

                        </div>
                        <!-- Player Cards -->
                        <div class="player-cards" id="player-cards-{{ player.id }}">
                            {% for card in player.cards %}
                            <div class="card">{{ card }}</div> 
                            {% endfor %}
                        </div>
                          <!-- See Cards Button (Visible Only to This Player) -->
                             <!-- Show "See Cards" Button only for the player viewing the page -->    
                          {% if player.id == user.id %}
                          <button class="see-cards-btn" id="see-cards-btn-{{ player.id }}" onclick="toggleCards({{ player.id }})">See Cards</button>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
             
                <!-- Center Content -->
                <div class="center-content">
                    <div class="table-limit">Table Limit</div>
                    <div class="table-pot">120,000</div>
                    <div class="table-current-bet">♦ 12,800</div>
                    <div class="progress-bar"><div class="progress"></div></div>
                    {% comment %} <div class="cards" id="player-cards">
                        <div class="card">A♥</div>
                        <div class="card">K♠</div>
                        <div class="card">Q♠</div>
                    </div> {% endcomment %}
                </div>
            </div>
            
            <!-- Bottom Controls -->
            <div class="controls" id="controls">
                <button class="control-button red" id="pack-btn" onclick="packGame()">Pack</button>
                <button class="control-button purple" id="sideshow-btn" onclick="requestSideshow()">Sideshow</button>
                <button class="control-button green" id="bet-btn" onclick="placeBet()">Bet</button> 
                <button class="control-button blue" id="double-bet-btn" onclick="placeDoubleBet()">Double Bet</button>
            </div>
        </div>
    </div>
</body>
</html>
{% endblock content%}
<script>
    let currentUserId = "{{ user.id }}";  // Store Django user ID in JavaScript
   console.log("Loading Javascript");
    let gameRoomId = "{{ game_room_id }}";  // Ensure this value is correctly rendered from the context
    console.log("Game Room ID:", gameRoomId);
    let playersData = [];  // Store the latest players data globally
    let currentTurn = 0;
    let tableMinimumBet = 0; // Add this globally to track the table minimum

const socket = new WebSocket(`ws://${window.location.host}/ws/game/${gameRoomId}/`);

socket.onopen = function(e) {
    console.log("Connected to game room");
};

socket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    console.log("Received game data:", data);
    console.log("Keys in received data:", Object.keys(data));

    if (data.type === "game_update") {
        currentTurn = data.current_turn;
        round_status = data.round_status;
        tableMinimumBet = Math.max(...playersData.map(p => p.current_bet || 0)); // Update table minimum
        console.log("tableMinimumBet:",tableMinimumBet);
        console.log("Round Status:", round_status);

        if (data.players) {
            playersData = data.players;  // Update global players data
            updatePlayersList(data.players);
        } else {
            console.error("No players data received!");
        }
        updateControls(data);
        updateGameUI(data);
        updateBetButton();  // Update the bet button text dynamically
        updateDoubleBetButton();  // Update the double bet button text dynamically

    }
    if (data.type === "player_disconnected") {
        // Handle player leaving scenario
        console.log(`Player ${data.player_id} has disconnected.`);
        removePlayerFromUI(data.player_id);
    }
};

socket.onclose = function(e) {
    console.log("Disconnected. Attempting to reconnect...");
    setTimeout(function() {
       window.location.href = '/gamedevelopment/interface/'; // Redirect to home page
    }, 1000);
};

function updatePlayersList(players) {
    console.log("updatePlayersList called with players:", players);  // Log the players array

    const playerList = document.querySelector(".players-grid");
    playerList.innerHTML = "";  // Clear existing player list

    players.forEach(player => {
        console.log(`Processing player: ${player.id}`);  // Log player ID
        // Update the player UI section with the latest data
        const playerElement = document.querySelector(`#player-${player.id}`);
        if (playerElement) {
            // Update existing player
            const playerInfo = playerElement.querySelector('.player-info');
            playerInfo.querySelector('.player-name').textContent = player.username;
            playerInfo.querySelector('.player-coins').textContent = `♦ ${player.coins}`;
            playerInfo.querySelector('.player-current-bet').textContent = `♦ ${player.current_bet}`; // Ensure this line is present
            playerInfo.querySelector('.player-img').src = player.avatar;
            playerElement.className = `player ${player.position}`;  // Update the position dynamically
            updatePlayerCards(player.id, player.cards);

 
        } else {
            // Add new player to the table if not already in the UI
            const playerDiv = document.createElement('div');
            playerDiv.classList.add('player', player.position);
            playerDiv.id = `player-${player.id}`;
            let buttonHTML = "";
            if (player.id == currentUserId && round_status == "betting") {
                buttonHTML = `<button class="see-cards-btn" id="see-cards-btn-${player.id}" onclick="toggleCards(${player.id})">See Cards</button>`;
            }
            playerDiv.innerHTML = `
                <img src="${player.avatar}" alt="Image" class="player-img">
                <div class="player-info">
                    <div class="player-name">${player.username}</div>
                    <div class="player-coins">♦ ${player.coins}</div>
                    <div class="player-current-bet" id="player-current-bet-${player.id}">♦ ${player.current_bet}</div> <!-- Ensure this line is present -->

                </div>
                <div class="player-cards" id="player-cards-${player.id}" style="display:none;"></div>  <!-- Cards go here (hidden initially) -->
                ${buttonHTML}
            `;

            playerList.appendChild(playerDiv);
        }
        updatePlayerCards(player.id, player.cards);
    });

}

// Function to toggle the visibility of the player's cards
function toggleCards(playerId) {
    const cardsContainer = document.querySelector(`#player-cards-${playerId}`);
    const seeButton = document.querySelector(`#see-cards-btn-${playerId}`);

    if (cardsContainer.style.display === "none") {
        cardsContainer.style.display = "block";
        seeButton.textContent = "Cards Seen";
        const data = {
            action: 'toggle_seen',
            player_id: currentUserId
        };
        socket.send(JSON.stringify(data));
    }
}

function updatePlayerCards(playerId, cards) {
    console.log(`Updating cards for Player ${playerId}:`, cards);
    
    const playerCardsContainer = document.querySelector(`#player-cards-${playerId}`);
    if (!playerCardsContainer) return;

    playerCardsContainer.innerHTML = "";  // Clear previous cards

    cards.forEach(card => {
        const cardElement = document.createElement('div');
        cardElement.classList.add('card');
        cardElement.textContent = card;  // Assuming cards are sent in "A♥", "K♠" format
        playerCardsContainer.appendChild(cardElement);
    });
}

function updateGameUI(data) {
    console.log("Updating game UI with data:", data);
    console.log("table-pot", data.table_pot);
    console.log("pot", data.pot);
    const tablePotElement = document.querySelector(".table-pot");
    if (tablePotElement && data.pot !== undefined) {  // Use 'pot' for consistency
        tablePotElement.textContent = `♦ ${data.pot}`;
    }
    const currentBetElement = document.querySelector(".table-current-bet");
    if (currentBetElement && data.pot !== undefined) {
        currentBetElement.textContent = `♦ ${data.pot}`;
    }
}

function updateControls(data) {
    const controls = document.getElementById("controls");
    const players = data.players;
    const round_status = data.round_status;
    const currentTurnIndex = data.current_turn;
    console.log("Current turn index:", currentTurnIndex);
    console.log("Current user ID:", currentUserId);
   
    if ( round_status === "betting" && players && players[currentTurnIndex]) {
        console.log("Player at current turn index:", players[currentTurnIndex]);
        console.log("Player ID at current turn index:", players[currentTurnIndex].id);
        if (Number(players[currentTurnIndex].id) === Number(currentUserId)) {
            controls.style.display = "block";
            console.log("Controls displayed for current user.");
        } else {
            console.error(`Player at index ${currentTurnIndex} does not match current user ID`);
            controls.style.display = "none";
        }
    } else {
        console.error(`Player at index ${currentTurnIndex} not found`);
        controls.style.display = "none";
    }
}


function removePlayerFromUI(playerId) {
    console.log("Attempting to remove player with ID:", playerId); // Check player ID
    const playerElement = document.getElementById(`player-${playerId}`);
    console.log("Player element:", playerElement);  // Log player element
    if (playerElement) {
        playerElement.remove();
        console.log(`Player ${playerId} removed from UI`);
    }
}

{% comment %} const exitButton = document.getElementById("exit-game-btn");

exitButton.addEventListener("click", function() {
    // Redirect to the interface page
    window.location.href = "/gamedevelopment/interface/";

}); {% endcomment %}
let isBetting = false;

function updateBetButton() {
    const betButton = document.getElementById("bet-btn");
    const currentPlayer = playersData.find(p => Number(p.id) === Number(currentUserId));
    if (currentPlayer && Number(playersData[currentTurn].id) === Number(currentUserId)) {
        const prevPlayerIndex = (currentTurn - 1 + playersData.length) % playersData.length;
        const prevPlayer = playersData[prevPlayerIndex];
        const minBet = currentPlayer.is_blind ? prevPlayer.current_bet : prevPlayer.current_bet * 2;
        console.log(`Bet button - prevPlayer.current_bet: ${prevPlayer.current_bet}, minBet: ${minBet}`);
        betButton.textContent = `Bet ${minBet}`;
        betButton.onclick = () => placeBet(minBet);
    }
    }


function placeBet(amount) {
        if (isBetting) {
            console.log("Bet is already in progress. Please wait.");
            return;
        }
        isBetting = true;
        const currentPlayer = playersData.find(p => Number(p.id) === Number(currentUserId));
        if (!currentPlayer) return;

        const prevPlayerIndex = (currentTurn - 1 + playersData.length) % playersData.length;
        const prevPlayer = playersData[prevPlayerIndex];
        const minBet = currentPlayer.is_blind ? prevPlayer.current_bet : prevPlayer.current_bet * 2;
        const betAmount = Math.max(amount, minBet); // Use passed amount or minimum

        const data = {
            action: 'place_bet',
            player_id: currentUserId,
            amount: betAmount
        };
        socket.send(JSON.stringify(data));
        console.log("Bet placed:", betAmount);

        document.getElementById("bet-btn").disabled = true;
        setTimeout(() => {
            isBetting = false;
            document.getElementById("bet-btn").disabled = false;
        }, 1000);
    }


   // Add this function to update the Double Bet button text
   function updateDoubleBetButton() {
    const doubleBetButton = document.getElementById("double-bet-btn");
    const currentPlayer = playersData.find(p => Number(p.id) === Number(currentUserId));

    const prevPlayerIndex = (currentTurn - 1 + playersData.length) % playersData.length;
    const prevPlayer = playersData[prevPlayerIndex];

    const doubleAmount = currentPlayer.is_blind ? prevPlayer.current_bet * 2 : 
                         (prevPlayer.is_blind ? prevPlayer.current_bet * 4 : prevPlayer.current_bet * 2);

    doubleBetButton.textContent = `Double Bet ${doubleAmount}`;
    console.log(`Updated Double Bet button to: ${doubleAmount}`);
}

// Update placeDoubleBet to reflect the amount being sent
function placeDoubleBet() {
    if (isBetting) {
        console.log("Bet is already in progress. Please wait.");
        return;
    }
    const currentPlayer = playersData.find(p => Number(p.id) === Number(currentUserId));
    
    isBetting = true;

    const prevPlayerIndex = (currentTurn - 1 + playersData.length) % playersData.length;
    const prevPlayer = playersData[prevPlayerIndex];
    

    const doubleAmount = currentPlayer.is_blind ? prevPlayer.current_bet * 2 : 
                         (prevPlayer.is_blind ? prevPlayer.current_bet * 4 : prevPlayer.current_bet * 2);
    
    socket.send(JSON.stringify({
        action: 'place_double_bet',
        player_id: currentUserId,
        amount: doubleAmount
    }));
    console.log(`Double bet placed: ${doubleAmount}`);

    document.getElementById("double-bet-btn").disabled = true;
    setTimeout(() => {
        isBetting = false;
        document.getElementById("double-bet-btn").disabled = false;
    }, 1000);
}


 function packGame() {
     const data = {
         action: 'pack',
         player_id: currentUserId
         // Player ID
     };
     socket.send(JSON.stringify(data));
     document.getElementById("pack-btn").disabled = true;
 }



 function requestSideshow() {
     const data = {
         action: 'sideshow',
         player_id: currentUserId,
         opponent_id: getOpponentId() //Player ID
     };
     socket.send(JSON.stringify(data));
 }

    function getOpponentId() {
    // Implement logic to get the opponent ID for sideshow
    // This is just a placeholder implementation
        const players = document.querySelectorAll('.player');
        for (let player of players) {
            if (player.id !== `player-${currentUserId}`) {
                return player.id.replace('player-', '');
            }
        }
        return null;
}
 document.getElementById("pack-btn").addEventListener("click", packGame);
 document.getElementById("sideshow-btn").addEventListener("click", requestSideshow); 

</script>
