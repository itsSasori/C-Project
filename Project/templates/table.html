{% load static %}
{%block content%}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Table</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/table.css' %}">
</head>
<body>
    <div class="container">
        {% comment %} <button class="exit-game-btn" id="exit-game-btn">Exit Game</button>
        {% endcomment %}
        
        <div class="poker-table">
            <!-- Top Icons -->
            <div class="top-icons">
                <button class="icon-button">ℹ</button>
                <button class="icon-button">⚙</button>
            </div>
            
            <!-- Poker Table -->
            <div class="table">
                <!-- Players -->
                <div class="players-grid">
                    {% for player in players %}
                    <div class="player" id="player-{{ player.id }}">
                        <img src="{{ player.avatar }}" alt="Image" class="player-img">
                        <div class="player-info">
                            <div class="player-name">{{ player.username }}</div>
                            <div class="player-coins">♦ {{ player.coins }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
             
                <!-- Center Content -->
                <div class="center-content">
                    <div class="table-limit">Table Limit</div>
                    <div class="table-pot">120,000</div>
                    <div class="current-bet">♦ 12,800</div>
                    <div class="progress-bar"><div class="progress"></div></div>
                    <div class="cards" id="player-cards">
                        <div class="card">A♥</div>
                        <div class="card">K♠</div>
                        <div class="card">Q♠</div>
                    </div>
                </div>
            </div>
            
            <!-- Bottom Controls -->
            <div class="controls">
                <button class="control-button red" id="pack-btn">Pack</button>
                <button class="control-button purple" id="sideshow-btn">Sideshow</button>
            </div>
        </div>
    </div>
</body>
</html>
    
<script>
   console.log("Loading Javascript");
    let gameRoomId = "{{ game_room_id }}";  // Ensure this value is correctly rendered from the context
    console.log("Game Room ID:", gameRoomId);

const socket = new WebSocket(`ws://${window.location.host}/ws/game/${gameRoomId}/`);

socket.onopen = function(e) {
    console.log("Connected to game room");
};

socket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    console.log("Received game data:", data);
    console.log("Keys in received data:", Object.keys(data));

    if (data.type === "game_update") {
        if (data.players) {
            updatePlayersList(data.players);
        } else {
            console.error("No players data received!");
        }
        updateGameUI(data);

    }
    if (data.type === "player_disconnected") {
        // Handle player leaving scenario
        console.log(`Player ${data.player_id} has disconnected.`);
        removePlayerFromUI(data.player_id);
    }
};

socket.onclose = function(e) {
    console.log("Disconnected. Attempting to reconnect...");
    setTimeout(function() {
        location.reload(); // Reload the page to re-establish connection
    }, 2000);
};

function updatePlayersList(players) {
    console.log("updatePlayersList called with players:", players);  // Log the players array

    const playerList = document.querySelector(".players-grid");
    playerList.innerHTML = "";  // Clear existing player list

    players.forEach(player => {
        console.log(`Processing player: ${player.id}`);  // Log player ID

       // const li = document.createElement("li");
       // li.textContent = `${player.username} (${player.status})`;
       // playerList.appendChild(li);

        // Update the player UI section with the latest data
        const playerElement = document.querySelector(`#player-${player.id}`);
        if (playerElement) {
            // Update existing player
            const playerInfo = playerElement.querySelector('.player-info');
            playerInfo.querySelector('.player-name').textContent = player.username;
            playerInfo.querySelector('.player-coins').textContent = `♦ ${player.coins}`;
            playerInfo.querySelector('.player-img').src = player.avatar;
            playerElement.className = `player ${player.position}`;  // Update the position dynamically
 
        } else {
            // Add new player to the table if not already in the UI
            const playerDiv = document.createElement('div');
            playerDiv.classList.add('player', player.position);
            playerDiv.id = `player-${player.id}`;
            
            playerDiv.innerHTML = `
                <img src="${player.avatar}" alt="Image" class="player-img">
                <div class="player-info">
                    <div class="player-name">${player.username}</div>
                    <div class="player-coins">♦ ${player.coins}</div>
                </div>
            `;

            playerList.appendChild(playerDiv);
        }
    });
}

function updateGameUI(data) {
    console.log("Updating game UI with data:", data);  // Log the data object
    console.log("table-pot", data.table_pot);
    console.log("pot", data.pot);
    // Update table pot and current bet
    const tablePotElement = document.querySelector(".table-pot");
   // tablePotElement.innerHTML = "";  // Clear existing table pot
    if (tablePotElement) {
        if (data.table_pot !== undefined) {
            tablePotElement.textContent = `♦ ${data.table_pot}`;
        } else {
            console.error("table_pot is undefined in the received data");
        }
    } else {
        console.error("Element with ID 'table-pot' not found! Ensure it exists in the HTML.");
    }

    const currentBetElement = document.querySelector(".current-bet");
    if (currentBetElement) {
        if (data.pot !== undefined) {
            currentBetElement.textContent = `♦ ${data.pot}`;
        } else {
            console.error("Current pot is undefined in the received data");
        }
    } else {
        console.error("Element with ID 'current-pot' not found!");
    }
   
    // Update cards in the center content
   // const cardsContainer = document.getElementById("player-cards");
  //  cardsContainer.innerHTML = "";  // Clear existing cards
  //  data.cards.forEach(card => {
 //       const cardDiv = document.createElement("div");
 //       cardDiv.classList.add("card");
 //       cardDiv.textContent = card;
 //       cardsContainer.appendChild(cardDiv);
   // });
}



function removePlayerFromUI(playerId) {
    console.log("Attempting to remove player with ID:", playerId); // Check player ID
    const playerElement = document.getElementById(`player-${playerId}`);
    console.log("Player element:", playerElement);  // Log player element
    if (playerElement) {
        playerElement.remove();
        console.log(`Player ${playerId} removed from UI`);
    }
}

{% comment %} const exitButton = document.getElementById("exit-game-btn");

exitButton.addEventListener("click", function() {
    // Redirect to the interface page
    window.location.href = "/gamedevelopment/interface/";

}); {% endcomment %}



// function placeBet(amount) {
//     const data = {
//         action: 'place_bet',
//         player_id: 1,  // Player ID
//         amount: amount
//     };
//     socket.send(JSON.stringify(data));
// }

// function packGame() {
//     const data = {
//         action: 'pack',
//         player_id: {{ user.id }}
//         // Player ID
//     };
//     socket.send(JSON.stringify(data));
//     document.getElementById("pack-btn").disabled = true;
// }

// function requestSideshow() {
//     const data = {
//         action: 'sideshow',
//         player_id: {{ user.id }}  // Player ID
//     };
//     socket.send(JSON.stringify(data));
// }

// document.getElementById("pack-btn").addEventListener("click", packGame);
// document.getElementById("sideshow-btn").addEventListener("click", requestSideshow); 

</script>
{% endblock content%}